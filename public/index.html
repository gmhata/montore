<!-- public/index.html -->
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg"/>
  <link rel="apple-touch-icon" href="/favicon.svg"/>
  <title>å•è¨ºã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
  <style>
    :root{
      --bg:#fef1f7; --card:#fff; --line:#fce7f3; --text:#111827; --muted:#9ca3af;
      --primary:#ec4899; --ok:#10b981; --err:#f472b6; --warn:#fbbf24; --press:#db2777;
    }
    *{ box-sizing:border-box }
    body{ margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif; background:var(--bg); color:var(--text); }
    header{
      background: linear-gradient(90deg,#ec4899,#f472b6);
      color:#fff; padding:14px 18px; display:flex; align-items:center; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.2);
    }
    body.immersive header{ display:none }
    header .brand{ font-weight:800; font-size:18px; display:flex; align-items:center; gap:8px }
    header .right{ margin-left:auto; color:#e5e7eb; font-size:13px; display:flex; align-items:center; gap:8px; }
    header .right .uname{ font-weight:700; color:#fff }
    header .right .secondary{ background:#fce7f3; color:#9f1239; padding:6px 10px; border-radius:10px; }

    .container{ max-width:1280px; margin:16px auto; padding:0 16px; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:14px; padding:16px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    h3{ margin:0 0 12px; }

    .screen{ display:none } 
    .screen.active{ display:block }

    .menu-grid{ display:flex; flex-direction:column; gap:12px; }
    .menu-card{
      background:#fff;
      border:1px solid #fce7f3;
      border-radius:8px;
      padding:14px 16px;
      cursor:pointer;
      transition:all .15s ease;
      position:relative;
      overflow:hidden;
    }
    .menu-card::after{
      content:'ğŸŒ¸';
      position:absolute;
      right:-10px;
      bottom:-10px;
      font-size:80px;
      opacity:0.04;
      pointer-events:none;
      line-height:1;
    }
    .menu-card:hover{
      border-color:#ec4899;
      background:#fdf2f8;
    }
    .menu-card:active{ transform: scale(0.98); }
    .menu-card-title{
      font-size: 15px;
      font-weight: 600;
      color:#374151;
      margin-bottom: 4px;
    }
    .menu-card:hover .menu-card-title{ color:#ec4899; }
    .muted{ color:var(--muted) } .small{ font-size:12px }
    .mono{ font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:12px }

    .grid{ display:grid; gap:12px; grid-template-columns: repeat(12, 1fr); }
    .col-3{ grid-column: span 3 } .col-12{ grid-column: span 12 }
    @media (max-width:960px){
      .col-3{ grid-column: span 12 }
      .home-layout{ grid-template-columns: 1fr !important; }
    }
    label{ display:flex; flex-direction:column; gap:6px; font-size:13px; color:#374151 }
    input[type="text"], select, textarea{
      width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:10px; background:#fff; font-size:14px;
    }
    textarea{ min-height:96px; resize:vertical }

    button{
      appearance:none; border:0; background:var(--primary); color:#fff; padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600; transition:background .12s ease, transform .05s ease, filter .12s ease;
    }
    button.secondary{
      background:#fce7f3; color:#9f1239;
    }
    button:active{ transform: translateY(1px); filter: brightness(.95); }
    button[disabled]{ opacity:.55; cursor:not-allowed }

    .scenario-grid{ display:grid; gap:12px; grid-template-columns: repeat(4, 1fr); }
    @media (max-width:960px){ .scenario-grid{ grid-template-columns: repeat(2, 1fr); } }
    .scenario-card{
      background:#fff; border:1px solid var(--line); border-radius:14px; padding:16px; cursor:pointer;
      display:flex; flex-direction:column; align-items:center; gap:8px; transition:.12s ease;
    }
    .scenario-card .emoji{ font-size:22px }
    .scenario-card.selected{
      outline:2px solid #ec4899;
      background:#fbcfe8;
      border-color:#ec4899;
    }
    .scenario-card:active{ transform: translateY(1px); filter:brightness(.98); }

    /* æ‚£è€…é¸æŠç”»é¢: 2ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    .patient-select-layout{ display:flex; gap:16px; min-height:500px }
    .patient-list-col{ flex:0 0 320px; display:flex; flex-direction:column; }
    .patient-detail-col{ flex:1; display:flex; flex-direction:column; }
    .patient-list{ 
      border:1px solid var(--line); border-radius:10px; background:#fff; 
      overflow-y:auto; max-height:500px; padding:8px;
    }
    .patient-item{
      padding:12px; border:1px solid var(--line); border-radius:8px; margin-bottom:8px;
      cursor:pointer; transition:.12s ease; background:#fff;
    }
    .patient-item:hover{ background:#fdf2f8 }
    .patient-item.selected{ outline:2px solid #ec4899; background:#fbcfe8; }
    .patient-item .name{ font-weight:700; font-size:14px; margin-bottom:4px }
    .patient-item .meta{ font-size:12px; color:var(--muted) }
    .patient-detail{
      border:1px solid var(--line); border-radius:10px; background:#fff; padding:16px;
      overflow-y:auto; flex:1;
    }
    .patient-detail .section{ margin-bottom:16px }
    .patient-detail .section-title{ font-weight:700; font-size:14px; margin-bottom:8px; color:#374151; border-left:3px solid #ec4899; padding-left:8px }
    .patient-detail .section-content{ font-size:13px; line-height:1.7; color:#4b5563; white-space:pre-wrap; background:#f9fafb; padding:10px; border-radius:6px }
    @media (max-width:960px){ 
      .patient-select-layout{ flex-direction:column }
      .patient-list-col{ flex:0 0 auto }
      .patient-list{ max-height:300px }
    }

    .stage{ position:fixed; inset:0; background:#000; display:flex; flex-direction:column; }
    .video-wrap{ position:relative; flex: 1; width:100%; height:100%; overflow:hidden; }
    .talk-video{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; background:#000; }
    .pill{ position:absolute; top:16px; left:16px; background:rgba(255,255,255,.98); color:#111827; font-weight:800; font-size:16px; padding:10px 14px; border-radius:999px; box-shadow:0 6px 14px rgba(0,0,0,.15) }
    .bottom-bar{ position:absolute; left:0; right:0; bottom:0; padding:12px; display:flex; flex-direction:column; gap:8px; background:linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,.22)); padding-bottom:16px; }
    .btn-eval{ background:#ec4899; border-radius:999px; padding:12px 18px; font-weight:800; line-height:1; }
    .btn-eval:active{ background:var(--press) }
    .progress{ position:relative; left:0; right:0; height:6px; border-radius:999px; background:rgba(255,255,255,.35); overflow:hidden; order: 2; }
    .progress > i{ display:block; height:100%; width:0%; background:linear-gradient(90deg,#ec4899,#f9a8d4); transition: width .2s ease }

    .report-note{ color:#6b7280; font-size:12px; margin:4px 0 8px }
    .tbl{ width:100%; border-collapse:collapse; border:1px solid #e5e7eb; font-size:14px; }
    .tbl th{ background:#f9fafb; color:#111827; border:1px solid #e5e7eb; padding:8px; }
    .tbl td{ border:1px solid #e5e7eb; padding:8px; vertical-align:top }
    .seg{ margin-top:14px } .seg .title{ font-weight:700; margin-bottom:6px; color:#111827 }
    .seg .box{ border:1px solid #e5e7eb; border-radius:8px; padding:10px 12px; background:#fff; white-space:pre-wrap; line-height:1.7 }
    .callout{ border:1px solid #fde68a; background:#fff7ed; color:#7c2d12; padding:10px 12px; border-radius:10px; margin:8px 0 }
    .chatlog{ border:1px solid #e5e7eb; border-radius:8px; background:#fff; padding:10px 12px; max-height:360px; overflow:auto }
    .line{ margin:6px 0; display:flex; gap:8px; align-items:flex-start }
    .badge{ border-radius:6px; padding:2px 6px; font-size:12px; color:#fff; min-width:56px; text-align:center }
    .badge-nurse{ background:#0f766e } .badge-patient{ background:#7c3aed }

    .admin-wrap{ display:flex; gap:16px; min-height:520px }
    .admin-nav{
      width:220px; border:1px solid var(--line); border-radius:14px;
      background:linear-gradient(180deg, #fff 0%, #fff8fb 100%);
      padding:16px; height:fit-content;
      box-shadow: 0 2px 8px rgba(236, 72, 153, 0.08);
    }
    .admin-nav button{
      width:100%; background:#fff; color:#9f1239; margin:6px 0;
      border:1px solid #fce7f3; text-align:left; padding:10px 12px;
      font-size:14px;
    }
    .admin-nav button:hover{
      background:#fdf2f8; border-color:#ec4899;
    }
    .admin-content{ flex:1; }
    .muted-box{ background:#f3f4f6; padding:8px; border-radius:10px; }

    .version-badge{
      position:fixed; right:12px; bottom:12px; z-index:50;
      background:#111827; color:#fff; font-size:12px; line-height:1;
      padding:6px 10px; border-radius:999px; opacity:.85;
    }

    .practice-actions{
      display:flex; justify-content:center; align-items:center; gap:8px; margin-top:20px;
    }
    .practice-actions .start{ width: 12rem; }

    .back-to-menu{
      position: fixed;
      top: 60px;
      right: 16px;
      z-index: 100;
      padding: 6px 12px;
      font-size: 12px;
      min-width: auto;
      background: #fce7f3;
      color: #9f1239;
      border-radius: 8px;
      font-weight: 600;
    }
    .back-to-menu:hover{
      background: #fbcfe8;
    }

    .nowrap{ white-space:nowrap; }

    .fab-br{
      position: fixed; right: 16px; bottom: 16px; z-index: 60;
      box-shadow: 0 6px 16px rgba(0,0,0,.15);
    }

    .history-item:hover{
      outline: 2px solid #fbcfe8;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,.08);
    }

    /* çµ±åˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ‘ãƒãƒ« - å³å´å›ºå®š */
    #statusPanel{
      position: fixed;
      top: 0;
      right: 0;
      width: 320px;
      height: 100vh;
      background: #2d3748;
      color: #e2e8f0;
      z-index: 150;
      transform: translateX(100%);
      transition: transform 0.3s ease;
      overflow-y: auto;
      box-shadow: -4px 0 12px rgba(0,0,0,0.3);
      font-size: 13px;
    }
    #statusPanel.visible{
      transform: translateX(0);
    }
    /* è©•ä¾¡ç”»é¢ã§ã¯å®Œå…¨ã«éè¡¨ç¤º */
    .screen#screen-result ~ #statusPanel,
    body:has(#screen-result.active) #statusPanel{
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
    }
    /* è©•ä¾¡ç”»é¢ã§ã¯ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ‘ãƒãƒ«ã‚‚éè¡¨ç¤º */
    body:has(#screen-result.active) #floatingPanels{
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
    }
    body:has(#screen-result.active) #toggleStatusBtn{
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
    }
    #statusPanel::-webkit-scrollbar{
      width: 6px;
    }
    #statusPanel::-webkit-scrollbar-track{
      background: #1a202c;
    }
    #statusPanel::-webkit-scrollbar-thumb{
      background: #4a5568;
      border-radius: 3px;
    }
    .status-header{
      background: #1a202c;
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #4a5568;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .status-title{
      font-weight: 700;
      font-size: 14px;
      color: #fff;
    }
    .status-toggle{
      background: #4a5568;
      color: #fff;
      border: none;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 11px;
      cursor: pointer;
      font-weight: 600;
    }
    .status-toggle:hover{
      background: #718096;
    }
    .status-section{
      padding: 16px;
      border-bottom: 1px solid #4a5568;
    }
    .status-section:last-child{
      border-bottom: none;
    }
    .status-section-title{
      font-weight: 700;
      font-size: 12px;
      color: #a0aec0;
      text-transform: uppercase;
      margin-bottom: 12px;
      letter-spacing: 0.05em;
    }
    .status-item{
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      margin: 6px 12px;
      background: rgba(255,255,255,0.05);
      border-radius: 4px;
      border: none;
      transition: all 0.2s ease;
    }
    .status-item:hover{
      background: rgba(255,255,255,0.08);
      transform: translateX(-2px);
    }
    
    /* ç‹¬ç«‹ã—ãŸå¸¯ãƒ‘ãƒãƒ«ï¼ˆä½“æ¸©ã€è¡€åœ§ãªã©ãŒå€‹åˆ¥ã«è¡¨ç¤ºï¼‰ - v1.88 */
    .independent-strip{
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 16px !important;
      margin: 6px 12px !important;
      background: rgba(255,255,255,0.06) !important;
      border-radius: 4px !important;
      border-left: none !important;
      border: none !important;
      transition: all 0.2s ease;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1) !important;
    }
    .independent-strip.vital-strip{
      border-left: none !important;
      border: none !important;
    }
    .independent-strip.exam-strip{
      border-left: none !important;
      border: none !important;
    }
    .vital-panel, .exam-panel{
      border-left: none !important;
      border: none !important;
    }
    .independent-strip:hover{
      background: rgba(255,255,255,0.1);
      transform: translateX(-3px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.25);
    }
    .strip-label{
      color: #cbd5e0;
      font-size: 12px;
      font-weight: 500;
      letter-spacing: 0.3px;
    }
    .strip-value{
      font-weight: 600;
      font-size: 14px;
      color: #fff;
    }
    .strip-value.abnormal{
      color: #fc8181;
    }
    .strip-value.normal{
      color: #68d391;
    }
    .status-label{
      color: #cbd5e0;
      font-size: 12px;
    }
    .status-value{
      font-weight: 600;
      color: #fff;
    }
    .status-value.abnormal{
      color: #fc8181;
    }
    .status-value.normal{
      color: #68d391;
    }
    .status-empty{
      color: #718096;
    }
    
    /* éŸ³å£°å†ç”Ÿãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼ã®ã‚·ãƒ³ãƒ—ãƒ«ãªé…ç½® */
    #rsAudioPlayer {
      margin: 16px 0;
      position: relative;
      z-index: 200;
      pointer-events: auto;
    }
    #rsAudioPlayer audio {
      display: block;
      width: 100%;
      max-width: 500px;
      pointer-events: auto;
      cursor: pointer;
    }
    .status-checked{
      text-align: center;
      padding: 16px;
      color: #68d391;
    }
    .toggle-status-btn{
      position: fixed;
      top: 70px;
      right: 16px;
      z-index: 140;
      background: #2d3748;
      color: #fff;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      cursor: pointer;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .toggle-status-btn:hover{
      background: #4a5568;
    }

    /* Scenario configuration */
    .keyword-config-item {
      margin-bottom: 16px;
    }
    .keyword-config-item label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
      color: #374151;
    }
    
    /* æµ®éŠãƒ‘ãƒãƒ«ï¼ˆä½“æ¸©ã€è¡€åœ§ãªã©å€‹åˆ¥è¡¨ç¤ºï¼‰ */
    #floatingPanels{
      position: fixed;
      top: 120px;
      right: 20px;
      z-index: 140;
      display: flex;
      flex-direction: column;
      gap: 6px;
      pointer-events: none;
    }
    .floating-panel{
      background: rgba(45, 55, 72, 0.95);
      border: none !important;
      border-left: none !important;
      border-radius: 4px;
      padding: 8px 16px !important;
      min-width: 180px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      animation: slideInRight 0.3s ease-out;
      pointer-events: auto;
    }
    .floating-panel.exam{
      border-left: none !important;
    }
    .floating-panel-label{
      font-size: 11px;
      color: #a0aec0;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 4px;
    }
    .floating-panel-value{
      font-size: 16px;
      font-weight: 600;
      color: #fff;
    }
    .floating-panel-value.abnormal{
      color: #fc8181;
    }
    .floating-panel-value.normal{
      color: #68d391;
    }
    @keyframes slideInRight{
      from{
        transform: translateX(100px);
        opacity: 0;
      }
      to{
        transform: translateX(0);
        opacity: 1;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      å•è¨ºã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼
    </div>
    <div class="right" id="topRight"></div>
  </header>

  <div class="container">
    <!-- ãƒ­ã‚°ã‚¤ãƒ³ -->
    <section id="screen-login" class="screen active">
      <div class="card">
        <h3>ãƒ­ã‚°ã‚¤ãƒ³</h3>
        <div class="row" id="authPanel">
          <button id="btnLogin">Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹</button>
          <button id="btnLogout" class="secondary" style="display:none">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
      </div>
      <div class="version-badge">version: 4.04</div>
    </section>

    <!-- ãƒˆãƒƒãƒ— -->
    <section id="screen-home" class="screen">
      <div class="home-layout" style="display:grid; grid-template-columns:1fr 2fr; gap:12px; align-items:start;">
        <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
        <div>
          <div class="menu-grid">
            <div id="goTest" class="menu-card" role="button" tabindex="0">
              <div class="menu-card-title">å•è¨ºç·´ç¿’</div>
              <div class="muted small">ç®¡ç†è€…ãŒä½œæˆã—ãŸæ‚£è€…ã‚’é¸æŠã—ã¦å¯¾è©±ç·´ç¿’</div>
            </div>
            <div id="goHistory" class="menu-card" role="button" tabindex="0">
              <div class="menu-card-title">å­¦ä¿®å±¥æ­´</div>
              <div class="muted small">éå»ã®ç·´ç¿’è¨˜éŒ²ã‚’ç¢ºèªã™ã‚‹</div>
            </div>
            <div id="goAIAnalysis" class="menu-card" role="button" tabindex="0">
              <div class="menu-card-title">AIã‚³ãƒ¼ãƒ</div>
              <div class="muted small">AIãŒã‚ãªãŸã‚’ã‚µãƒãƒ¼ãƒˆ</div>
            </div>
            <div id="goManual" class="menu-card" role="button" tabindex="0">
              <div class="menu-card-title">ãƒãƒ‹ãƒ¥ã‚¢ãƒ«</div>
              <div class="muted small">ç”¨èªã®å®šç¾©ã¨ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</div>
            </div>
            <div id="goAdmin" class="menu-card" role="button" tabindex="0" style="display:none">
              <div class="menu-card-title">ç®¡ç†è€…</div>
              <div class="muted small">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚„è¨­å®šã‚’ç®¡ç†ã™ã‚‹</div>
            </div>
          </div>

          <div class="row" style="display:none">
            <button id="checkRoleBtn" class="secondary">æ¨©é™ãƒã‚§ãƒƒã‚¯</button>
            <pre id="checkRoleResult" class="small" style="background:#f3f4f6; padding:8px; margin:0; white-space:pre-wrap; flex:1"></pre>
          </div>
        </div>

        <!-- ç·´ç¿’ã‚¢ãƒ‰ãƒã‚¤ã‚¹ -->
        <div class="menu-card" id="adviceCard" style="display:none; background:#fff8fb; position:relative; z-index:1;">
          <div class="menu-card-title">ç·´ç¿’ã‚¢ãƒ‰ãƒã‚¤ã‚¹</div>
          <div id="adviceContent" class="muted small" style="margin-top:8px; line-height:1.6;">
            <div style="padding:12px;">èª­ã¿è¾¼ã¿ä¸­...</div>
          </div>
        </div>
      </div>
      <div class="version-badge">version: 4.04</div>
    </section>

    <!-- å¯¾è©± -->
    <section id="screen-talk" class="screen">
      <div class="stage">
        <div class="video-wrap">
          <video id="tkVideo" class="talk-video" playsinline muted loop preload="auto" src="/assets/patient_idle.mp4"></video>
          <div id="tkPill" class="pill">æº–å‚™ä¸­â€¦</div>
          <div class="bottom-bar">
            <!-- ä¸Šæ®µï¼šãƒ†ã‚­ã‚¹ãƒˆãƒãƒ¼ã€æ®‹ã‚Šæ™‚é–“ã€è©•ä¾¡ãƒœã‚¿ãƒ³ -->
            <div style="display: flex; align-items: center; gap: 12px; width: 100%; order: 1;">
              <!-- å¯¾è©±ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤ºï¼ˆå·¦å´ï¼‰ -->
              <div id="conversationTextArea" style="display:none; flex: 1; background:rgba(60,60,60,0.92); color:#fff; padding:12px 18px; font-size:14px; line-height:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; border-radius:999px; font-weight:800;">
                <span id="conversationTextDisplay"></span>
              </div>
              <!-- ã‚¹ãƒšãƒ¼ã‚µãƒ¼ï¼ˆãƒ†ã‚­ã‚¹ãƒˆãƒãƒ¼éè¡¨ç¤ºæ™‚ã«å³å¯„ã›ï¼‰ -->
              <div id="conversationSpacer" style="flex: 1;"></div>
              <!-- æ®‹ã‚Šæ™‚é–“ï¼ˆå³å´ï¼‰ -->
              <div style="display: flex; align-items: center; gap: 6px; font-size: 16px; font-weight: 600;">
                <span style="color: #6b7280;">æ®‹ã‚Šæ™‚é–“:</span>
                <span id="conversationTimer" style="color: #10b981; font-family: 'Courier New', monospace; font-size: 18px;">3:00</span>
              </div>
              <!-- è©•ä¾¡ãƒœã‚¿ãƒ³ï¼ˆå³å´ï¼‰ -->
              <button id="tkFinish" class="btn-eval" disabled>è©•ä¾¡ã«é€²ã‚€</button>
            </div>
            <!-- ä¸‹æ®µï¼šé€²æ—ãƒãƒ¼ -->
            <div class="progress"><i id="tkProg"></i></div>
          </div>
        </div>
      </div>
      <div style="position:fixed; left:16px; bottom:16px; color:#fff; opacity:.85; font-size:12px">
        sessionId: <span id="tkSid" class="mono">-</span>
      </div>
    </section>

    <!-- æ‚£è€…é¸æŠ -->
    <section id="screen-patient-select" class="screen">
      <div class="card">
        <h3>æ‚£è€…é¸æŠ</h3>
        <div class="muted small" style="margin-bottom:12px">å·¦ã®æ‚£è€…ãƒªã‚¹ãƒˆã‹ã‚‰é¸æŠã™ã‚‹ã¨ã€å³å´ã«è©³ç´°æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
        <div id="patientListLoading" class="muted">èª­ã¿è¾¼ã¿ä¸­...</div>
        <div id="patientListError" class="callout" style="display:none"></div>
        
        <div id="patientSelectLayout" class="patient-select-layout" style="display:none">
          <!-- å·¦å´: æ‚£è€…ãƒªã‚¹ãƒˆ -->
          <div class="patient-list-col">
            <div class="patient-list" id="patientList"></div>
          </div>
          
          <!-- å³å´: æ‚£è€…è©³ç´° -->
          <div class="patient-detail-col">
            <div class="patient-detail" id="patientDetail">
              <div class="muted" style="text-align:center;padding:40px 0">æ‚£è€…ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
            </div>
            <!-- Version 3.06: å¯¾è©±ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤ºè¨­å®š -->
            <div id="conversationOptionsArea" style="margin-top:16px; padding:12px; background:#f9fafb; border-radius:8px; border:1px solid #e5e7eb; display:none">
              <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-weight:500">
                <input type="checkbox" id="showConversationText" style="width:18px; height:18px; cursor:pointer">
                <span>å¯¾è©±ãƒ†ã‚­ã‚¹ãƒˆã‚’ç”»é¢ä¸‹ã«è¡¨ç¤ºã™ã‚‹</span>
              </label>
              <div class="muted small" style="margin-top:6px; margin-left:26px">
                ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹ã¨ã€ç¾åœ¨è©±ã—ã¦ã„ã‚‹å†…å®¹ãŒç”»é¢ä¸‹éƒ¨ã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§è¡¨ç¤ºã•ã‚Œã¾ã™
              </div>
            </div>
            
            <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
              <button id="downloadPatientPdf" class="secondary" style="display:none">å°åˆ·/PDF</button>
              <button id="startWithSelectedPatient" class="" style="display:none">ã“ã®æ‚£è€…ã§å¯¾è©±é–‹å§‹</button>
            </div>
          </div>
        </div>
        
        <button id="backFromPatientSelect" class="back-to-menu">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
      </div>
    </section>

    <!-- å­¦ä¿®å±¥æ­´ -->
    <section id="screen-history" class="screen">
      <div class="card">
        <h3>å­¦ä¿®å±¥æ­´</h3>
        <div class="muted small" style="margin-bottom:12px">éå»ã®å¯¾è©±ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç¢ºèªã§ãã¾ã™ã€‚</div>
        <div id="historyLoading" class="muted">èª­ã¿è¾¼ã¿ä¸­...</div>
        <div id="historyError" class="callout" style="display:none"></div>
        <div id="historyList" style="display:none"></div>
        <button id="backFromHistory" class="back-to-menu">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
      </div>
    </section>

    <!-- AIã‚³ãƒ¼ãƒ -->
    <section id="screen-ai-analysis" class="screen">
      <div class="card">
        <h3>AIã‚³ãƒ¼ãƒ</h3>
        <div class="muted small" style="margin-bottom:1rem">
          ã‚ãªãŸã®å¯¾è©±ãƒ‡ãƒ¼ã‚¿ã‚’AIãŒåˆ†æã—ã€å­¦ç¿’ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚è‡ªç„¶è¨€èªã§è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>
          <strong>ä¾‹:</strong> ã€Œç§ã®å¯¾è©±ã®å¼·ã¿ã¨å¼±ã¿ã‚’æ•™ãˆã¦ãã ã•ã„ã€ã€Œã‚¹ã‚³ã‚¢ã‚’ä¸Šã’ã‚‹ã«ã¯ã©ã†ã™ã‚Œã°ã„ã„ã§ã™ã‹ã€ã€Œæœ€è¿‘ã®æˆé•·ã‚’åˆ†æã—ã¦ãã ã•ã„ã€
        </div>

        <div style="display:flex; gap:1rem; align-items:flex-start">
          <!-- å·¦å´: åˆ†æå±¥æ­´ãƒªã‚¹ãƒˆ -->
          <div style="flex:0 0 280px; max-height:600px; overflow-y:auto; border:1px solid #e5e7eb; border-radius:6px; padding:8px">
            <div style="font-weight:600; margin-bottom:8px; padding:4px">åˆ†æå±¥æ­´</div>
            <div id="ai-history-list-student">
              <div class="muted small" style="padding:8px">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
          </div>

          <!-- å³å´: æ–°è¦åˆ†æ & è©³ç´°è¡¨ç¤º -->
          <div style="flex:1">
            <div style="margin-bottom:1.5rem">
              <label style="display:block; margin-bottom:0.5rem; font-weight:600">è³ªå•ã‚’å…¥åŠ›:</label>
              <textarea id="ai-query-student" rows="3" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:4px; font-size:14px"
                placeholder="ä¾‹: ç§ã®å¯¾è©±ã‚¹ã‚­ãƒ«ã®æ”¹å–„ç‚¹ã‚’è©³ã—ãæ•™ãˆã¦ãã ã•ã„"></textarea>
              <button id="ai-analyze-btn-student" style="margin-top:0.5rem; padding:10px 20px; background:#ec4899; color:white; border:none; border-radius:12px; cursor:pointer; font-size:14px; font-weight:600">
                åˆ†æã‚’å®Ÿè¡Œ
              </button>
            </div>

            <div id="ai-result-student" style="display:none">
              <h4>åˆ†æçµæœ</h4>
              <div id="ai-metadata-student" style="background:#f3f4f6; padding:12px; border-radius:6px; margin-bottom:1rem; font-size:0.9em"></div>
              <div id="ai-content-student" style="background:white; padding:20px; border:1px solid #e5e7eb; border-radius:6px; line-height:1.8"></div>
            </div>

            <div id="ai-loading-student" style="display:none; text-align:center; padding:2rem">
              <div style="font-size:2rem">â³</div>
              <div>AIãŒåˆ†æä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„...</div>
            </div>

            <div id="ai-error-student" style="display:none" class="callout"></div>
          </div>
        </div>

        <button id="backFromAIAnalysis" class="back-to-menu" style="margin-top:1.5rem">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
      </div>
    </section>

    <!-- çµæœ -->
    <section id="screen-result" class="screen">
      <div class="card">
        <h3>å•è¨ºã‚¹ã‚­ãƒ«åˆ†æãƒ¬ãƒãƒ¼ãƒˆ</h3>
        <div class="report-note">ï¼ˆå„é …ç›®ã¯ 2ç‚¹ãƒ»1ç‚¹ãƒ»0ç‚¹ ã®ä¸‰æ®µéšè©•ä¾¡ï¼‰</div>
        <div class="small muted">ã‚»ãƒƒã‚·ãƒ§ãƒ³ID: <span id="rsSid" class="mono">-</span></div>

        <div id="rsOut" class="seg" style="margin-top:10px"></div>

        <div id="rsAudioPlayer" style="display:none"></div>

        <div class="seg">
          <div class="title">ä¼šè©±ãƒ­ã‚°</div>
          <div id="rsLog" class="chatlog"></div>
        </div>

        <div style="margin-top:16px; text-align:right">
          <button id="rsBackHome" class="secondary">è¨­å®šã«æˆ»ã‚‹</button>
        </div>
      </div>
    </section>

    <!-- ç®¡ç†è€…ç”»é¢ -->
    <section id="screen-admin" class="screen">
      <div class="admin-wrap">
        <nav class="admin-nav">
          <div class="muted small" id="adminRoleNote">æ¨©é™ç¢ºèªä¸­â€¦</div>
          <button class="admin-menu" data-target="pane-settings">å…¨èˆ¬è¨­å®š</button>
          <button class="admin-menu" data-target="pane-users">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</button>
          <button class="admin-menu" data-target="pane-patient-creation">æ‚£è€…ç®¡ç†</button>
          <button class="admin-menu" data-target="pane-stats">å­¦ä¿®ç®¡ç†</button>
          <button class="admin-menu" data-target="pane-scenarios">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç®¡ç†</button>
          <button class="admin-menu" data-target="pane-analysis">çµ±è¨ˆ</button>
          <button class="admin-menu" data-target="pane-ai-analysis">AIåˆ†æ</button>
        </nav>
        <div class="admin-content" style="padding-left:12px">
          <div id="pane-settings" class="card">
            <h3>å…¨èˆ¬è¨­å®š</h3>
          </div>

          <div id="pane-users" class="card" style="display:none">
            <h3>ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</h3>
            <div class="muted-box small">æ¨©é™ï¼šä¸€èˆ¬ï¼ç®¡ç†è€… ã‚’åˆ‡ã‚Šæ›¿ãˆã§ãã¾ã™ã€‚</div>
            <div style="overflow:auto">
              <table class="tbl" id="userTable">
                <thead>
                  <tr><th style="width:80px">UserNo</th><th>Mail</th><th>åå‰</th><th style="width:160px">æ¨©é™</th></tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <div id="pane-patient-creation" class="card" style="display:none">
            <!-- Version 3.0: æ‚£è€…ä½œæˆï¼ˆç—‡çŠ¶åˆ¥ãƒ¢ãƒ¼ãƒ‰ã‹ã‚‰ç§»è¡Œï¼‰å†…å®¹ã¯admin.jsã§å‹•çš„ã«ç”Ÿæˆ -->
          </div>

          <div id="pane-stats" class="card" style="display:none">
            <h3>å­¦ä¿®ç®¡ç†</h3>
            <div class="muted small">èª­è¾¼ä¸­ã«å°‘ã—æ™‚é–“ãŒã‹ã‹ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚</div>
          </div>

          <div id="pane-scenarios" class="card" style="display:none">
            <h3>ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç®¡ç†</h3>
            <div class="muted small">å„ã‚·ãƒŠãƒªã‚ªã§ã®ãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³ã¨èº«ä½“è¨ºå¯Ÿã®é …ç›®åˆ¥ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¾ã™ã€‚</div>

            <!-- ãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³è¨­å®š -->
            <div style="margin:30px 0; padding:20px; background:#f9fafb; border-radius:8px">
              <h4 style="margin-bottom:16px; color:#ec4899">ãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰è¨­å®š</h4>

              <div class="keyword-config-item">
                <label>ä½“æ¸©:</label>
                <input type="text" id="vital_temperature" placeholder="ä½“æ¸©, ç†±, temperatureï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰" style="width:100%; padding:8px; border:1px solid #d1d5db; border-radius:4px">
              </div>

              <div class="keyword-config-item">
                <label>è¡€åœ§:</label>
                <input type="text" id="vital_bloodPressure" placeholder="è¡€åœ§, blood pressureï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰" style="width:100%; padding:8px; border:1px solid #d1d5db; border-radius:4px">
              </div>

              <div class="keyword-config-item">
                <label>è„ˆæ‹:</label>
                <input type="text" id="vital_pulse" placeholder="è„ˆæ‹, è„ˆ, pulse, heart rateï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰" style="width:100%; padding:8px; border:1px solid #d1d5db; border-radius:4px">
              </div>

              <div class="keyword-config-item">
                <label>å‘¼å¸æ•°:</label>
                <input type="text" id="vital_respiration" placeholder="å‘¼å¸, å‘¼å¸æ•°, respiratoryï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰" style="width:100%; padding:8px; border:1px solid #d1d5db; border-radius:4px">
              </div>

              <div class="keyword-config-item">
                <label>é…¸ç´ é£½å’Œåº¦:</label>
                <input type="text" id="vital_spo2" placeholder="spo2, é…¸ç´ é£½å’Œåº¦, é…¸ç´ , oxygenï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰" style="width:100%; padding:8px; border:1px solid #d1d5db; border-radius:4px">
              </div>
            </div>

            <!-- èº«ä½“è¨ºå¯Ÿè¨­å®š -->
            <div style="margin:30px 0; padding:20px; background:#f0f9ff; border-radius:8px">
              <h4 style="margin-bottom:16px; color:#0ea5e9">èº«ä½“è¨ºå¯Ÿã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰è¨­å®š</h4>

              <div class="keyword-config-item">
                <label>è¦–è¨º:</label>
                <input type="text" id="exam_inspection" placeholder="è¦–è¨º, è¦‹, inspection, lookï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰" style="width:100%; padding:8px; border:1px solid #d1d5db; border-radius:4px">
              </div>

              <div class="keyword-config-item">
                <label>è§¦è¨º:</label>
                <input type="text" id="exam_palpation" placeholder="è§¦è¨º, è§¦, palpation, touchï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰" style="width:100%; padding:8px; border:1px solid #d1d5db; border-radius:4px">
              </div>

              <div class="keyword-config-item">
                <label>è´è¨º:</label>
                <input type="text" id="exam_auscultation" placeholder="è´è¨º, è´, auscultation, listenï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰" style="width:100%; padding:8px; border:1px solid #d1d5db; border-radius:4px">
              </div>

              <div class="keyword-config-item">
                <label>æ‰“è¨º:</label>
                <input type="text" id="exam_percussion" placeholder="æ‰“è¨º, å©, percussionï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰" style="width:100%; padding:8px; border:1px solid #d1d5db; border-radius:4px">
              </div>
            </div>

            <button id="saveScenarioConfig" style="padding:12px 24px; background:#ec4899; color:white; border:none; border-radius:6px; font-weight:600; cursor:pointer">
              è¨­å®šã‚’ä¿å­˜
            </button>
            <span id="scenarioConfigStatus" style="margin-left:12px; color:#10b981"></span>
          </div>

          <div id="pane-analysis" class="card" style="display:none">
            <h3>çµ±è¨ˆ</h3>
            <div class="muted small">æ¬¡ã‚¹ãƒ†ãƒƒãƒ—ã§å®Ÿè£…ã—ã¾ã™ã€‚</div>
          </div>

          <div id="pane-ai-analysis" class="card" style="display:none">
            <!-- AIåˆ†æã®å†…å®¹ã¯admin.jsã§å‹•çš„ã«ç”Ÿæˆ -->
          </div>
        </div>
      </div>
      <button id="backHomeAdmin" class="back-to-menu">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
    </section>

    <!-- ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ç”»é¢ -->
    <section id="screen-manual" class="screen">
      <div class="card" style="max-width:900px; margin:0 auto">
        <h3>ãƒãƒ‹ãƒ¥ã‚¢ãƒ«</h3>

        <div style="margin-bottom:32px">
          <h4 style="color:#ec4899; border-bottom:2px solid #fce7f3; padding-bottom:8px">ç”¨èªã®å®šç¾©</h4>

          <div style="margin:16px 0; padding:12px; background:#fff8fb; border-left:4px solid #ec4899; border-radius:6px">
            <div style="font-weight:700; margin-bottom:6px">ã‚»ãƒƒã‚·ãƒ§ãƒ³</div>
            <div style="font-size:14px; line-height:1.7">
              <strong>1å›ã®ç·´ç¿’å˜ä½</strong>ã‚’æŒ‡ã—ã¾ã™ã€‚ç·´ç¿’é–‹å§‹ã‹ã‚‰è©•ä¾¡å®Œäº†ã¾ã§ãŒ1ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ã™ã€‚<br>
              ä¾‹ï¼šã€Œã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°10å›ã€= 10å›ã®ç·´ç¿’ã‚’å®Ÿæ–½ã—ãŸã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚
            </div>
          </div>

          <div style="margin:16px 0; padding:12px; background:#fff8fb; border-left:4px solid #ec4899; border-radius:6px">
            <div style="font-weight:700; margin-bottom:6px">ä¼šè©± / ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div>
            <div style="font-size:14px; line-height:1.7">
              <strong>1ã¤1ã¤ã®ç™ºè¨€</strong>ã‚’æŒ‡ã—ã¾ã™ã€‚çœ‹è­·å¸«ã¨æ‚£è€…ã®å€‹åˆ¥ã®ç™ºè©±ãŒ1ä»¶ãšã¤ã‚«ã‚¦ãƒ³ãƒˆã•ã‚Œã¾ã™ã€‚<br>
              ä¾‹ï¼šã€Œä¼šè©±23ä»¶ã€= ã‚»ãƒƒã‚·ãƒ§ãƒ³å†…ã§çœ‹è­·å¸«ã¨æ‚£è€…ãŒåˆè¨ˆ23å›ç™ºè¨€ã—ãŸã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚
            </div>
          </div>

          <div style="margin:16px 0; padding:12px; background:#fff8fb; border-left:4px solid #ec4899; border-radius:6px">
            <div style="font-weight:700; margin-bottom:6px">è©•ä¾¡</div>
            <div style="font-size:14px; line-height:1.7">
              <strong>AIã«ã‚ˆã‚‹ãƒ«ãƒ¼ãƒ–ãƒªãƒƒã‚¯è©•ä¾¡</strong>ã‚’æŒ‡ã—ã¾ã™ã€‚å„è©•ä¾¡é …ç›®ã¯0ç‚¹ãƒ»1ç‚¹ãƒ»2ç‚¹ã®3æ®µéšã§è©•ä¾¡ã•ã‚Œã€åˆè¨ˆã‚¹ã‚³ã‚¢ãŒ100ç‚¹æº€ç‚¹ã«æ›ç®—ã•ã‚Œã¾ã™ã€‚<br>
              å¯¾è©±çµ‚äº†å¾Œã«ã€Œè©•ä¾¡ã«é€²ã‚€ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã“ã¨ã§è©•ä¾¡ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
            </div>
          </div>

          <div style="margin:16px 0; padding:12px; background:#fff8fb; border-left:4px solid #ec4899; border-radius:6px">
            <div style="font-weight:700; margin-bottom:6px">è©•ä¾¡æ¸ˆã¿ã‚»ãƒƒã‚·ãƒ§ãƒ³</div>
            <div style="font-size:14px; line-height:1.7">
              <strong>AIè©•ä¾¡ã‚’å®Œäº†ã—ãŸã‚»ãƒƒã‚·ãƒ§ãƒ³</strong>ã‚’æŒ‡ã—ã¾ã™ã€‚çµ±è¨ˆåˆ†æã‚„ç™ºè©±ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æã®å¯¾è±¡ã¨ãªã‚‹ã®ã¯è©•ä¾¡æ¸ˆã¿ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã¿ã§ã™ã€‚<br>
              âš ï¸ è©•ä¾¡ã‚’å®Ÿè¡Œã—ãªã„ã¨å­¦ä¿®å±¥æ­´ã‚„åˆ†æã®å¯¾è±¡ã«å«ã¾ã‚Œã¾ã›ã‚“ã€‚
            </div>
          </div>
        </div>


        <div style="margin-bottom:32px">
          <h4 style="color:#ec4899; border-bottom:2px solid #fce7f3; padding-bottom:8px">åŸºæœ¬çš„ãªä½¿ã„æ–¹</h4>

          <div style="margin:16px 0">
            <div style="font-weight:700; margin-bottom:6px">1. ç·´ç¿’ã‚’é–‹å§‹ã™ã‚‹</div>
            <div style="font-size:14px; line-height:1.7; color:#6b7280">
              ãƒˆãƒƒãƒ—ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€Œå•è¨ºç·´ç¿’ã€ã‚’é¸ã³ã€æ‚£è€…æƒ…å ±ã‚’è¨­å®šã—ã¦ã€Œé–‹å§‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¾ã™ã€‚
            </div>
          </div>

          <div style="margin:16px 0">
            <div style="font-weight:700; margin-bottom:6px">2. å¯¾è©±ã‚’è¡Œã†</div>
            <div style="font-size:14px; line-height:1.7; color:#6b7280">
              éŸ³å£°å…¥åŠ›ã§æ‚£è€…ã¨å¯¾è©±ã—ã¾ã™ã€‚ãƒã‚¤ã‚¯ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦è©±ã—ã‹ã‘ã¦ãã ã•ã„ã€‚æ‚£è€…ã¯AIãŒè‡ªå‹•å¿œç­”ã—ã¾ã™ã€‚
            </div>
          </div>

          <div style="margin:16px 0">
            <div style="font-weight:700; margin-bottom:6px">3. è©•ä¾¡ã‚’å—ã‘ã‚‹</div>
            <div style="font-size:14px; line-height:1.7; color:#6b7280">
              å¯¾è©±ãŒçµ‚ã‚ã£ãŸã‚‰ã€Œè©•ä¾¡ã«é€²ã‚€ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚AIãŒå•è¨ºã‚¹ã‚­ãƒ«ã‚’è©•ä¾¡ã—ã€ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’æä¾›ã—ã¾ã™ã€‚<br>
              <span style="color:#dc2626; font-weight:600">âš ï¸ é‡è¦ï¼šè©•ä¾¡ã‚’å®Ÿè¡Œã—ãªã„ã¨å­¦ä¿®å±¥æ­´ã«è¨˜éŒ²ã•ã‚Œã¾ã›ã‚“ã€‚</span>
            </div>
          </div>

          <div style="margin:16px 0">
            <div style="font-weight:700; margin-bottom:6px">4. çµæœã‚’ç¢ºèªã™ã‚‹</div>
            <div style="font-size:14px; line-height:1.7; color:#6b7280">
              è©•ä¾¡çµæœç”»é¢ã§å„é …ç›®ã®ã‚¹ã‚³ã‚¢ã€ç·è©•ã€æ”¹å–„ç‚¹ã‚’ç¢ºèªã§ãã¾ã™ã€‚ã€Œå­¦ä¿®å±¥æ­´ã€ã‹ã‚‰ã„ã¤ã§ã‚‚éå»ã®è¨˜éŒ²ã‚’æŒ¯ã‚Šè¿”ã‚Œã¾ã™ã€‚
            </div>
          </div>
        </div>

        <div style="background:#fef3c7; border:1px solid #fbbf24; border-radius:8px; padding:16px; margin-top:24px">
          <div style="font-weight:700; color:#92400e; margin-bottom:8px">ãƒ’ãƒ³ãƒˆ</div>
          <ul style="margin:0; padding-left:20px; color:#78350f; font-size:14px; line-height:1.8">
            <li>è©•ä¾¡ã‚’å—ã‘ãªã„ã¨çµ±è¨ˆåˆ†æã®å¯¾è±¡ã«ãªã‚Šã¾ã›ã‚“</li>
            <li>ã€Œç·´ç¿’ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã€ã¯éå»ã®è©•ä¾¡ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™</li>
            <li>AIã‚³ãƒ¼ãƒã§ã¯ã€Œç§ã®å¼·ã¿ã¨å¼±ã¿ã¯ï¼Ÿã€ã€Œã‚¹ã‚³ã‚¢ã‚’ä¸Šã’ã‚‹ã«ã¯ï¼Ÿã€ãªã©è‡ªç”±ã«è³ªå•ã§ãã¾ã™</li>
          </ul>
        </div>

        <button id="backFromManual" class="back-to-menu" style="margin-top:24px">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
      </div>
    </section>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
  <script>
    // MermaidåˆæœŸåŒ–
    if (typeof mermaid !== 'undefined') {
      mermaid.initialize({ startOnLoad: false, theme: 'default' });
    }
  </script>
  <!-- Firebase Configuration (injected at build/runtime) -->
  <script>
    // Firebase Config will be injected here by build process or loaded from /firebase-config.js
    window.FIREBASE_CONFIG = window.FIREBASE_CONFIG || null;
  </script>
  <script src="/firebase-config.js?v=4.04" onerror="console.warn('firebase-config.js not found, using placeholder')"></script>
  
  <script type="module" src="/auth.js?v=4.04"></script>
  <script type="module" src="/practice.js?v=4.04"></script>
  <script type="module" src="/admin.js?v=4.04"></script>

  <script>
    function esc(s){return String(s??"").replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c]))}

    function setScreen(id){
      document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
      const el = document.getElementById(id);
      if (el) el.classList.add("active");
    }

    function decodeB64Unicode(b){
      try{
        const bytes = Uint8Array.from(atob(b), c=>c.charCodeAt(0));
        return new TextDecoder().decode(bytes);
      }catch(_){
        try{ return decodeURIComponent(escape(atob(b))); }catch{ return ""; }
      }
    }
    function parseJwt(token){
      try{
        const p = token.split(".")[1]; if(!p) return {};
        const json = decodeB64Unicode(p);
        return JSON.parse(json||"{}");
      }catch{ return {}; }
    }

    async function renderTopRight(){
      const el = document.getElementById("topRight");
      if (!el) return;

      const token = window.getIdTokenAsync ? await window.getIdTokenAsync() : null;
      if (!token){ el.innerHTML = ""; return; }

      const claims = parseJwt(token);
      let disp = claims.name || claims.displayName || claims.email || claims.user_id || "ãƒ¦ãƒ¼ã‚¶ãƒ¼";
      el.innerHTML = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­: <span class="uname">${esc(disp)}</span> <button id="btnLogoutTop" class="secondary">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>`;
      const hookLogout = ()=>{
        const topBtn = document.getElementById("btnLogoutTop");
        const hiddenLogout = document.getElementById("btnLogout");
        if(topBtn && hiddenLogout){ topBtn.onclick = ()=> hiddenLogout.click(); }
      };
      hookLogout();

      try{
        const r = await fetch("/api/roles/me",{headers:{Authorization:"Bearer "+token}});
        const j = await r.json().catch(()=>({}));
        const better = j?.name || j?.displayName || j?.email || j?.uid;
        if (better && better !== disp){
          el.innerHTML = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­: <span class="uname">${esc(better)}</span> <button id="btnLogoutTop" class="secondary">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>`;
          hookLogout();
        }
      }catch{}
    }

    window.addEventListener("auth-state",(ev)=>{
      const signed = !!ev?.detail?.signedIn;
      if (signed){
        const cur = document.querySelector(".screen.active")?.id;
        if (cur === "screen-login") setScreen("screen-home");
        renderTopRight();
      }else{
        setScreen("screen-login");
        const el=document.getElementById("topRight"); if(el) el.innerHTML="";
        const card = document.getElementById("goAdmin"); if (card) card.style.display = "none";
      }
    });

    async function autoShowAdmin(){
      try{
        const token = window.getIdTokenAsync ? await window.getIdTokenAsync() : null;
        if (!token) return;
        const r = await fetch("/api/roles/me", { headers:{ Authorization:"Bearer " + token } });
        const j = await r.json().catch(()=>({}));
        if (j && j.role){ document.getElementById("adminRoleNote").textContent = "ã‚ãªãŸã®æ¨©é™: " + j.role; }
        if (j && j.role === "admin"){
          const card = document.getElementById("goAdmin");
          if (card) card.style.display = "";
        }
        renderTopRight();
      }catch{}
    }
    window.addEventListener("auth-state", (ev)=>{
      if (ev?.detail?.signedIn) autoShowAdmin();
      else { const card = document.getElementById("goAdmin"); if (card) card.style.display = "none"; }
    });
    document.addEventListener("DOMContentLoaded", autoShowAdmin);

    document.addEventListener("DOMContentLoaded", ()=>{
      const goAdmin = document.getElementById("goAdmin");
      const backHomeAdmin = document.getElementById("backHomeAdmin");
      if (goAdmin){
        goAdmin.addEventListener("click", ()=>{
          setScreen("screen-admin");
          // â–¼ è¿½åŠ ï¼šç®¡ç†ç”»é¢ã‚’é–‹ã„ãŸã‚‰å¿…ãšã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã€ã‚’é¸æŠ
          const btn = document.querySelector('.admin-nav .admin-menu[data-target="pane-users"]');
          if (btn) {
            btn.click(); // admin.js ã®ã‚¿ãƒ–åˆ‡æ›¿ãƒ­ã‚¸ãƒƒã‚¯ã«å§”è­²
          } else {
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆä¸‡ä¸€ click ãƒãƒ³ãƒ‰ãƒ©ãŒæœªç™»éŒ²ã§ã‚‚è¡¨ç¤ºãŒå‡ºã‚‹ã‚ˆã†ã«ï¼‰
            document.querySelectorAll('.admin-content > .card').forEach(p=>p.style.display='none');
            const pane=document.getElementById('pane-users'); if(pane) pane.style.display='';
          }
        });
      }
      if (backHomeAdmin){
        backHomeAdmin.addEventListener("click", ()=> setScreen("screen-home"));
      }

      // AIåˆ†æç”»é¢ã¸ã®é·ç§»
      const goAIAnalysis = document.getElementById("goAIAnalysis");
      const backFromAIAnalysis = document.getElementById("backFromAIAnalysis");
      if (goAIAnalysis) {
        goAIAnalysis.addEventListener("click", ()=> {
          setScreen("screen-ai-analysis");
          // ç”»é¢ã‚’é–‹ã„ãŸã¨ãã«å…¥åŠ›æ¬„ã¨çµæœã‚’ã‚¯ãƒªã‚¢
          const queryInput = document.getElementById("ai-query-student");
          const resultDiv = document.getElementById("ai-result-student");
          if (queryInput) queryInput.value = "";
          if (resultDiv) resultDiv.style.display = "none";
          loadAIAnalysisHistory(); // å±¥æ­´èª­ã¿è¾¼ã¿
        });
      }
      if (backFromAIAnalysis) {
        backFromAIAnalysis.addEventListener("click", ()=> setScreen("screen-home"));
      }

      // ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ç”»é¢ã¸ã®é·ç§»
      const goManual = document.getElementById("goManual");
      const backFromManual = document.getElementById("backFromManual");
      if (goManual) {
        goManual.addEventListener("click", ()=> {
          setScreen("screen-manual");
        });
      }
      if (backFromManual) {
        backFromManual.addEventListener("click", ()=> setScreen("screen-home"));
      }

      // AIåˆ†æå®Ÿè¡Œãƒœã‚¿ãƒ³
      const aiAnalyzeBtn = document.getElementById("ai-analyze-btn-student");
      const aiQueryInput = document.getElementById("ai-query-student");
      if (aiAnalyzeBtn && aiQueryInput) {
        aiAnalyzeBtn.addEventListener("click", async ()=> {
          const query = aiQueryInput.value.trim();
          if (!query) {
            alert("è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            return;
          }
          await executeAIAnalysisStudent(query);
        });
      }
    });

    // å­¦ç”Ÿç”¨AIåˆ†æå®Ÿè¡Œé–¢æ•°
    async function executeAIAnalysisStudent(query) {
      const loadingDiv = document.getElementById("ai-loading-student");
      const errorDiv = document.getElementById("ai-error-student");
      const resultDiv = document.getElementById("ai-result-student");
      const metadataDiv = document.getElementById("ai-metadata-student");
      const contentDiv = document.getElementById("ai-content-student");

      // UIçŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
      if (loadingDiv) loadingDiv.style.display = "block";
      if (errorDiv) errorDiv.style.display = "none";
      if (resultDiv) resultDiv.style.display = "none";

      try {
        const token = await window.getIdTokenAsync();
        if (!token) {
          throw new Error("èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã§ãã¾ã›ã‚“");
        }

        // Version 3.0: AI Coachåˆ©ç”¨åˆ¶é™ãƒã‚§ãƒƒã‚¯
        const limitCheckResponse = await fetch("/api/ai-coach/check-limit", {
          method: "GET",
          headers: {
            "Authorization": `Bearer ${token}`
          }
        });
        const limitCheck = await limitCheckResponse.json();
        
        if (!limitCheck.ok || !limitCheck.allowed) {
          throw new Error(limitCheck.unlimited 
            ? "AI Coachã®åˆ©ç”¨åˆ¶é™ãƒã‚§ãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸ" 
            : `AI Coachã®åˆ©ç”¨å›æ•°åˆ¶é™ã«é”ã—ã¾ã—ãŸï¼ˆæ®‹ã‚Š${limitCheck.remaining || 0}å› / ${limitCheck.maxCount}å›ï¼‰`);
        }

        const response = await fetch("/api/student/ai-analysis", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          credentials: "include",
          body: JSON.stringify({ query })
        });

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.error || `HTTP ${response.status}`);
        }

        // çµæœã‚’è¡¨ç¤º
        if (loadingDiv) loadingDiv.style.display = "none";
        if (resultDiv) resultDiv.style.display = "block";

        // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
        if (metadataDiv && result.metadata) {
          const hasUnevaluated = result.metadata.sessionsWithoutScore > 0;
          metadataDiv.innerHTML = `
            <strong>ã‚ãªãŸã®ãƒ‡ãƒ¼ã‚¿æ¦‚è¦:</strong>
            åˆè¨ˆã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°: ${result.metadata.totalSessions}
            ${hasUnevaluated ? `ï¼ˆè©•ä¾¡æ¸ˆã¿: ${result.metadata.sessionsWithScore}, è©•ä¾¡æœªå®Ÿè¡Œ: ${result.metadata.sessionsWithoutScore}ï¼‰` : ''} |
            å¹³å‡ã‚¹ã‚³ã‚¢: ${result.metadata.avgScore}ç‚¹ |
            æœ€é«˜ã‚¹ã‚³ã‚¢: ${result.metadata.bestScore}ç‚¹
            ${hasUnevaluated ? `<br><span style="color:#d97706;">âš ï¸ ${result.metadata.sessionsWithoutScore}å€‹ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§è©•ä¾¡ãŒæœªå®Ÿè¡Œã§ã™ã€‚å¯¾è©±å¾Œã¯å¿…ãšã€Œè©•ä¾¡ã«é€²ã‚€ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</span>` : ''}
          `;
        }

        // Version 3.0: AI Coachä½¿ç”¨è¨˜éŒ²
        await fetch("/api/ai-coach/record-usage", {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${token}`
          }
        }).catch(err => console.error('Failed to record AI Coach usage:', err));

        // AIåˆ†æçµæœã‚’ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã¨ã—ã¦è¡¨ç¤º
        if (contentDiv) {
          // marked.jsãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆã¯ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
          if (typeof marked !== 'undefined') {
            contentDiv.innerHTML = marked.parse(result.analysis);

            // Mermaidã‚°ãƒ©ãƒ•ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            if (typeof mermaid !== 'undefined') {
              setTimeout(() => {
                const mermaidDivs = contentDiv.querySelectorAll('code.language-mermaid');
                mermaidDivs.forEach((code, index) => {
                  const pre = code.parentElement;
                  const mermaidDiv = document.createElement('div');
                  mermaidDiv.className = 'mermaid';
                  mermaidDiv.textContent = code.textContent;
                  pre.replaceWith(mermaidDiv);
                });
                mermaid.run({ querySelector: '.mermaid' });
              }, 100);
            }

            // Chart.jsã‚°ãƒ©ãƒ•ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            if (typeof Chart !== 'undefined') {
              setTimeout(() => {
                const chartCodeBlocks = contentDiv.querySelectorAll('code.language-chartjs');
                chartCodeBlocks.forEach((code, index) => {
                  try {
                    const chartConfig = JSON.parse(code.textContent);
                    const pre = code.parentElement;

                    // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆ
                    const canvasContainer = document.createElement('div');
                    canvasContainer.style.cssText = 'max-width: 600px; margin: 20px auto; padding: 20px; background: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);';

                    const canvas = document.createElement('canvas');
                    canvas.id = `chart-student-${index}`;
                    canvasContainer.appendChild(canvas);
                    pre.replaceWith(canvasContainer);

                    // Chart.jsã§ã‚°ãƒ©ãƒ•ã‚’æç”»
                    new Chart(canvas.getContext('2d'), chartConfig);
                  } catch (error) {
                    console.error('[Chart.js] Failed to render chart:', error);
                  }
                });
              }, 150);
            }
          } else {
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤º
            const esc = (s) => String(s ?? "").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
            contentDiv.innerHTML = `<pre style="white-space: pre-wrap; font-family: inherit">${esc(result.analysis)}</pre>`;
          }
        }

      } catch (error) {
        console.error("[AI Analysis Student] Error:", error);
        if (loadingDiv) loadingDiv.style.display = "none";
        if (errorDiv) {
          errorDiv.style.display = "block";
          errorDiv.textContent = error.message;
        }
      } finally {
        // åˆ†æå®Œäº†å¾Œã«å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢ã—ã¦å±¥æ­´ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
        const queryInput = document.getElementById("ai-query-student");
        if (queryInput) queryInput.value = "";
        loadAIAnalysisHistory();
      }
    }

    // å­¦ç”Ÿç”¨AIåˆ†æå±¥æ­´èª­ã¿è¾¼ã¿é–¢æ•°
    async function loadAIAnalysisHistory() {
      const listDiv = document.getElementById("ai-history-list-student");
      if (!listDiv) return;

      try {
        const token = await window.getIdTokenAsync();
        if (!token) {
          listDiv.innerHTML = '<div class="muted small" style="padding:8px">ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™</div>';
          return;
        }

        const response = await fetch("/api/student/ai-analysis-history", {
          headers: { "Authorization": `Bearer ${token}` }
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const result = await response.json();

        if (!result.ok || !result.history || result.history.length === 0) {
          listDiv.innerHTML = '<div class="muted small" style="padding:8px">å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>';
          return;
        }

        // å±¥æ­´ã‚¢ã‚¤ãƒ†ãƒ ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        listDiv.innerHTML = result.history.map(item => {
          const date = new Date(item.createdAt).toLocaleString('ja-JP', {
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
          });
          const queryPreview = item.query.length > 40
            ? item.query.substring(0, 40) + '...'
            : item.query;

          return `
            <div class="history-item" data-id="${item.id}" style="padding:8px; cursor:pointer; border-bottom:1px solid #f3f4f6; transition:background 0.2s">
              <div style="font-size:0.75em; color:#9ca3af; margin-bottom:2px">${date}</div>
              <div style="font-size:0.85em; color:#374151">${escapeHtml(queryPreview)}</div>
            </div>
          `;
        }).join('');

        // ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’è¿½åŠ 
        listDiv.querySelectorAll('.history-item').forEach(item => {
          item.addEventListener('click', async function() {
            const itemId = this.dataset.id;
            const historyItem = result.history.find(h => h.id === itemId);
            if (historyItem) {
              await displayHistoryItem(historyItem);
            }
          });

          // ãƒ›ãƒãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
          item.addEventListener('mouseenter', function() {
            this.style.background = '#f9fafb';
          });
          item.addEventListener('mouseleave', function() {
            this.style.background = 'transparent';
          });
        });

      } catch (error) {
        console.error('[AI Analysis History] Failed to load:', error);
        listDiv.innerHTML = '<div class="muted small" style="padding:8px; color:#dc2626">å±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
      }
    }

    // å±¥æ­´ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
    async function displayHistoryItem(item) {
      const resultDiv = document.getElementById("ai-result-student");
      const metadataDiv = document.getElementById("ai-metadata-student");
      const contentDiv = document.getElementById("ai-content-student");
      const loadingDiv = document.getElementById("ai-loading-student");
      const errorDiv = document.getElementById("ai-error-student");

      // UIçŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
      if (loadingDiv) loadingDiv.style.display = "none";
      if (errorDiv) errorDiv.style.display = "none";
      if (resultDiv) resultDiv.style.display = "block";

      // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
      if (metadataDiv && item.metadata) {
        const hasUnevaluated = item.metadata.sessionsWithoutScore > 0;
        metadataDiv.innerHTML = `
          <strong>ãƒ‡ãƒ¼ã‚¿æ¦‚è¦ï¼ˆåˆ†ææ™‚ç‚¹ï¼‰:</strong>
          åˆè¨ˆã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°: ${item.metadata.totalSessions}
          ${hasUnevaluated ? `ï¼ˆè©•ä¾¡æ¸ˆã¿: ${item.metadata.sessionsWithScore}, è©•ä¾¡æœªå®Ÿè¡Œ: ${item.metadata.sessionsWithoutScore}ï¼‰` : ''} |
          å¹³å‡ã‚¹ã‚³ã‚¢: ${item.metadata.avgScore}ç‚¹ |
          æœ€é«˜ã‚¹ã‚³ã‚¢: ${item.metadata.bestScore}ç‚¹
        `;
      }

      // AIåˆ†æçµæœã‚’ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã¨ã—ã¦è¡¨ç¤º
      if (contentDiv) {
        if (typeof marked !== 'undefined') {
          contentDiv.innerHTML = marked.parse(item.analysis);

          // Mermaidã‚°ãƒ©ãƒ•ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
          if (typeof mermaid !== 'undefined') {
            setTimeout(() => {
              const mermaidDivs = contentDiv.querySelectorAll('code.language-mermaid');
              mermaidDivs.forEach((code, index) => {
                const pre = code.parentElement;
                const mermaidDiv = document.createElement('div');
                mermaidDiv.className = 'mermaid';
                mermaidDiv.textContent = code.textContent;
                pre.replaceWith(mermaidDiv);
              });
              mermaid.run({ querySelector: '.mermaid' });
            }, 100);
          }

          // Chart.jsã‚°ãƒ©ãƒ•ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
          if (typeof Chart !== 'undefined') {
            setTimeout(() => {
              const chartCodeBlocks = contentDiv.querySelectorAll('code.language-chartjs');
              chartCodeBlocks.forEach((code, index) => {
                try {
                  const chartConfig = JSON.parse(code.textContent);
                  const pre = code.parentElement;

                  const canvasContainer = document.createElement('div');
                  canvasContainer.style.cssText = 'max-width: 600px; margin: 20px auto; padding: 20px; background: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);';

                  const canvas = document.createElement('canvas');
                  canvas.id = `chart-history-${index}-${Date.now()}`;
                  canvasContainer.appendChild(canvas);
                  pre.replaceWith(canvasContainer);

                  new Chart(canvas.getContext('2d'), chartConfig);
                } catch (error) {
                  console.error('[Chart.js] Failed to render chart:', error);
                }
              });
            }, 150);
          }
        } else {
          const esc = (s) => String(s ?? "").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
          contentDiv.innerHTML = `<pre style="white-space: pre-wrap; font-family: inherit">${esc(item.analysis)}</pre>`;
        }
      }
    }

    // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°
    function escapeHtml(text) {
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return text.replace(/[&<>"']/g, m => map[m]);
    }
  </script>

  <!-- å€‹åˆ¥è¡¨ç¤ºç”¨ã®æµ®éŠãƒ‘ãƒãƒ«ã‚³ãƒ³ãƒ†ãƒŠ -->
  <div id="floatingPanels"></div>

  <!-- çµ±åˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ‘ãƒãƒ« -->
  <button id="toggleStatusBtn" class="toggle-status-btn" style="display:none">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</button>

  <div id="statusPanel">
    <div class="status-header">
      <div class="status-title">å¯¾è©±æƒ…å ±</div>
      <button id="closeStatusBtn" class="status-toggle">é–‰ã˜ã‚‹</button>
    </div>

    <!-- éŸ³å£°åˆ†æã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆéè¡¨ç¤ºï¼‰ -->
    <div class="status-section" id="speechStatusSection" style="display:none">
      <div class="status-section-title">éŸ³å£°åˆ†æ</div>
      <div id="speechStatusContent">
        <div class="status-empty">éŸ³å£°åˆ†æãƒ‡ãƒ¼ã‚¿ã‚’åé›†ä¸­...</div>
      </div>
    </div>

    <!-- ãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="status-section" id="vitalStatusSection" style="display:none">
      <div class="status-section-title">ãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³</div>
      <div id="vitalStatusContent">
        <div class="status-empty">æœªæ¸¬å®š</div>
      </div>
    </div>

    <!-- èº«ä½“è¨ºå¯Ÿã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="status-section" id="examStatusSection" style="display:none">
      <div class="status-section-title">èº«ä½“è¨ºå¯Ÿ</div>
      <div id="examStatusContent">
        <div class="status-empty">æœªå®Ÿæ–½</div>
      </div>
    </div>
  </div>


</body>
</html>